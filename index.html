<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- é’ˆå¯¹å®‰å“å¹³æ¿ä¼˜åŒ–çš„è§†å£è®¾ç½® -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æµªæµªå±±å°ç”»å¸ˆ Pro Max</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #FF7043;
            --accent: #FFCA28;
            --success: #66BB6A;
            --wood-dark: #5D4037;
            --font-main: 'ZCOOL KuaiLe', cursive, sans-serif;
        }

        body {
            margin: 0; padding: 0; overflow: hidden;
            background-color: #F3E5AB;
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.1) 0px, rgba(255,255,255,0.1) 2px, transparent 2px, transparent 10px);
            font-family: var(--font-main);
            user-select: none; -webkit-user-select: none;
            /* å…³é”®ï¼šä¿®å¤å®‰å“å¹³æ¿è§¦æ‘¸å»¶è¿Ÿ */
            touch-action: none; 
            -webkit-tap-highlight-color: transparent;
        }

        #app { width: 100vw; height: 100vh; position: relative; overflow: hidden; }

        /* 3D æŒ‰é’® */
        .btn-3d {
            position: relative; border: none; outline: none;
            background: var(--primary); color: white;
            padding: 15px 40px; font-size: 26px; border-radius: 20px;
            font-family: var(--font-main); cursor: pointer;
            box-shadow: 0 8px 0 #D84315, 0 15px 20px rgba(0,0,0,0.2);
            transition: transform 0.1s; z-index: 100; /* æé«˜å±‚çº§ */
        }
        .btn-3d:active { transform: translateY(8px); box-shadow: 0 0 0 #D84315; }
        .btn-green { background: var(--success); box-shadow: 0 8px 0 #388E3C; }
        .btn-green:active { box-shadow: 0 0 0 #388E3C; }

        /* å·¥å…·æ  */
        .tool-icon {
            width: 70px; height: 70px; background: white; border-radius: 15px;
            display: flex; justify-content: center; align-items: center; font-size: 35px;
            box-shadow: 0 6px 0 #ccc; border: 2px solid #eee; cursor: pointer;
        }
        .tool-icon.active { background: var(--accent); border-color: #FFA000; box-shadow: 0 6px 0 #FFA000; color: white; transform: scale(1.1); }

        /* 1. å°é¢ */
        .screen-cover {
            position: absolute; inset: 0; z-index: 100;
            background-size: cover; background-position: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .screen-cover.no-img { background: linear-gradient(180deg, #81D4FA, #A5D6A7); }
        .title-box {
            background: rgba(255, 255, 255, 0.95); padding: 50px 80px;
            border-radius: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center; border: 8px solid var(--primary);
            animation: float 3s ease-in-out infinite;
        }

        /* 2. é€‰è§’ */
        .screen-select {
            position: absolute; inset: 0; z-index: 90; background: #FFF8E1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .role-grid { display: flex; gap: 30px; margin: 40px; flex-wrap: wrap; justify-content: center; }
        .polaroid {
            background: white; padding: 15px 15px 40px 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            transform: rotate(-2deg); transition: all 0.2s; cursor: pointer; width: 180px; text-align: center;
        }
        .polaroid.active { transform: scale(1.1) rotate(0deg); border: 4px solid var(--primary); z-index: 10; }
        .p-img { width: 100%; aspect-ratio: 1; object-fit: cover; background: #eee; border: 1px solid #ddd; }

        /* 3. åœ°å›¾ */
        .screen-map {
            position: absolute; inset: 0; z-index: 80; background: #FFF3E0;
            padding: 100px 40px; overflow-y: auto;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 30px; align-content: start;
        }
        .level-item {
            background: white; border-radius: 20px; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 8px 0 #eee, 0 10px 20px rgba(0,0,0,0.05);
            transition: transform 0.1s; cursor: pointer; border: 2px solid #fff;
        }
        .level-item:active { transform: translateY(8px); box-shadow: none; }
        .level-item.locked { opacity: 0.5; filter: grayscale(1); pointer-events: none; }

        /* 4. æ¸¸æˆé¡µ */
        .screen-game {
            position: absolute; inset: 0; z-index: 200; background: #FAF9F6;
            display: flex; flex-direction: column;
        }
        .game-header {
            height: 90px; padding: 0 30px; background: white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); display: flex;
            justify-content: space-between; align-items: center; z-index: 50;
        }
        .game-body {
            flex: 1; position: relative; margin: 20px;
            background: white; border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); overflow: hidden;
            touch-action: none; cursor: crosshair;
        }
        
        .layer-trace {
            position: absolute; inset: 0; z-index: 1; pointer-events: none;
            display: flex; justify-content: center; align-items: center;
        }
        .trace-img {
            max-width: 90%; max-height: 90%; object-fit: contain;
            opacity: 0.25; filter: grayscale(100%); transition: 1s;
        }
        .trace-img.done { opacity: 1; filter: grayscale(0%); transform: scale(1.05); }

        /* SVG é€šå…³ç‰¹æ•ˆ */
        .svg-path-bg { fill: none; stroke: #ddd; stroke-width: 20; stroke-linecap: round; transition: all 1s; }
        .svg-path-guide { fill: none; stroke: #999; stroke-width: 2; stroke-dasharray: 10,10; }
        
        .svg-won .svg-path-guide { opacity: 0; }
        .svg-won circle { display: none; }

        canvas { position: absolute; inset: 0; z-index: 10; width: 100%; height: 100%; }

        /* æ•…äº‹å¼¹çª— */
        .modal-mask {
            position: absolute; inset: 0; background: rgba(0,0,0,0.7); z-index: 999;
            display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .story-book {
            width: 80%; max-width: 700px; background: #FFF8E1;
            border-radius: 30px; border: 10px solid #5D4037;
            padding: 40px; text-align: center;
            box-shadow: 0 30px 80px rgba(0,0,0,0.5);
            animation: popIn 0.4s;
        }

        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #D32F2F; color: white; padding: 10px 20px;
            border-radius: 20px; z-index: 10000;
        }

        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
        @keyframes popIn { from{transform:scale(0.8);opacity:0} to{transform:scale(1);opacity:1} }
    </style>
</head>
<body>

<div id="app">

    <div v-if="errorMsg" class="toast">{{ errorMsg }}</div>

    <!-- 1. å°é¢ -->
    <div v-if="state === 'welcome'" class="screen-cover" :class="{'no-img': imgError.cover}"
         :style="!imgError.cover ? {backgroundImage: 'url(assets/cover.jpg)'} : {}">
        <div class="title-box">
            <h1 style="font-size: 70px; color: #E65100; margin: 0;">æµªæµªå±±å°ç”»å¸ˆ</h1>
            <p style="font-size: 28px; color: #8D6E63; margin-top: 10px;">V13.0 å¹³æ¿å…¼å®¹ç‰ˆ</p>
            <div style="margin-top: 50px;">
                <!-- è¿™é‡Œçš„ @click="startApp" æ˜¯å…³é”®å…¥å£ -->
                <button class="btn-3d" @click="startApp">ğŸ¨ è¿›å±±å­¦è‰º</button>
            </div>
        </div>
    </div>

    <!-- 2. é€‰è§’ -->
    <div v-if="state === 'select'" class="screen-select">
        <h2 style="font-size: 40px; color: #5D4037;">è°é™ªä½ ä¸€èµ·ç”»ç”»ï¼Ÿ</h2>
        <div class="role-grid">
            <div v-for="role in roles" :key="role.id" 
                 class="polaroid" :class="{active: selectedRole?.id === role.id}"
                 @click="tryRole(role)">
                <img :src="role.img" class="p-img" @error="onImgError(role.name)">
                <div style="font-size: 22px; margin-top: 10px;">{{ role.name }}</div>
            </div>
        </div>
        <button v-if="selectedRole" class="btn-3d btn-green" @click="confirmRole">å‡ºå‘ ğŸš€</button>
    </div>

    <!-- 3. åœ°å›¾ -->
    <div v-if="state === 'map'" class="screen-map">
        <div style="position:fixed; top:0; left:0; right:0; height:80px; background:rgba(255,255,255,0.9); z-index:10; display:flex; align-items:center; padding:0 30px; box-shadow:0 5px 10px rgba(0,0,0,0.05);">
            <div style="font-size: 24px; font-weight: bold; color: #5D4037;">ç¬¬ {{ maxLevel + 1 }} å…³</div>
        </div>
        <div v-for="(level, idx) in levels" :key="idx"
             class="level-item" :class="{locked: idx > maxLevel}"
             @click="enterLevel(idx)">
             <div style="font-size: 50px; margin-bottom: 10px;">{{ level.icon }}</div>
             <div style="font-size: 18px; color: #5D4037;">{{ level.title }}</div>
             <div v-if="idx < maxLevel" style="color: #FFB74D; margin-top:5px;">â­â­â­</div>
        </div>
    </div>

    <!-- 4. æ¸¸æˆé¡µ -->
    <div v-if="state === 'game'" class="screen-game">
        <div class="game-header">
            <button class="btn-3d" style="padding: 10px 25px; font-size: 20px;" @click="backToMap">â†© è¿”å›</button>
            <div style="display: flex; gap: 20px;">
                <div class="tool-icon" :class="{active: !isEraser}" @click="setTool(false)">ğŸ–Œï¸</div>
                <div class="tool-icon" :class="{active: isEraser}" @click="setTool(true)">ğŸ§½</div>
            </div>
            <button class="btn-3d btn-green" style="padding: 10px 30px; font-size: 20px;" @click="checkResult">âœ¨ ç”»å¥½äº†</button>
        </div>

        <div class="game-body" ref="stageRef">
            <div class="layer-trace">
                <!-- SVG: ç»‘å®šåŠ¨æ€é¢œè‰² -->
                <svg v-if="currentLevel.type === 'svg'" :class="{'svg-won': isLevelDone}" style="width:100%; height:100%" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid meet">
                    <!-- åº•è‰²è·¯å¾„ -->
                    <path :d="currentLevel.path" class="svg-path-bg" 
                          :style="isLevelDone ? {stroke: currentLevel.color, filter: `drop-shadow(0 0 10px ${currentLevel.color})`, strokeWidth: '25px'} : {}"/>
                    <!-- å¼•å¯¼è·¯å¾„ -->
                    <path :d="currentLevel.path" class="svg-path-guide" :style="{opacity: isLevelDone ? 0 : 1}"/>
                    <!-- åŠ¨æ€çº¢ç‚¹ -->
                    <circle r="15" fill="#FF7043" :style="{display: isLevelDone ? 'none' : 'block'}">
                        <animateMotion :dur="currentLevel.speed" repeatCount="indefinite">
                            <mpath :href="`#p-${currentLevel.id}`"/>
                        </animateMotion>
                    </circle>
                    <defs><path :id="`p-${currentLevel.id}`" :d="currentLevel.path"/></defs>
                </svg>
                <!-- å›¾ç‰‡ -->
                <img v-else :src="currentLevel.img" class="trace-img" :class="{done: isLevelDone}" @error="onImgError('å…³å¡å›¾')">
            </div>
            <canvas ref="canvasRef"></canvas>
        </div>
    </div>

    <!-- æ•…äº‹å¼¹çª— -->
    <div v-if="showModal" class="modal-mask">
        <div class="story-book">
            <div style="font-size: 80px; margin-bottom: 20px;">
                <img v-if="currentLevel.type === 'img'" :src="currentLevel.img" style="height:150px; object-fit:contain;">
                <span v-else>{{ currentLevel.icon }}</span>
            </div>
            <h2 style="color:#D84315; margin-bottom:20px;">{{ currentLevel.title }}</h2>
            <p style="font-size: 24px; line-height: 1.6; text-align: left; margin-bottom: 40px; color:#5D4037;">
                {{ currentLevel.story }}
            </p>
            <button class="btn-3d" @click="startGame">å¼€å§‹æŒ‘æˆ˜</button>
        </div>
    </div>

</div>

<script>
const { createApp, ref, computed, nextTick } = Vue;

/* SVG è·¯å¾„ */
const PATHS = {
    l1: "M350 180 L380 280 H480 L400 340 L430 440 L350 380 L270 440 L300 340 L220 280 H320 Z M250 420 Q150 500 100 500",
    l2: "M400 220 C530 100 750 220 400 550 C50 220 270 100 400 220 Z M600 220 Q650 180 620 150",
    l3: "M320 550 Q280 550 250 580 M480 550 Q520 550 550 580 M320 550 L320 400 Q250 400 200 300 Q200 200 300 150 Q400 100 500 150 Q600 200 600 300 Q550 400 480 400 L480 550"
};

const ROLES = [
    { id: 'pig', name: 'å°çŒªå¦–', img: 'assets/11.jpg' },
    { id: 'frog', name: 'è›¤èŸ†å¤§å“¥', img: 'assets/9.jpg' },
    { id: 'weasel', name: 'é»„é¼ ç‹¼', img: 'assets/10.jpg' },
    { id: 'gorilla', name: 'çŒ©çŒ©æ€ª', img: 'assets/12.jpg' }
];

/* å‰§æœ¬æ•°æ® */
const LEVELS = [
    { 
        id: 1, type: 'svg', title: "å¹¸è¿æµæ˜Ÿ", icon: "â­", path: PATHS.l1, speed: '6s', color: '#FFD700',
        story: "è¯è¯´æµªæµªå±±çš„å°å¦–æ€ªï¼Œè™½ç„¶æ¯å¤©éƒ½åœ¨åˆ·é”…ï¼Œä½†ä»–å¿ƒé‡Œè—ç€ä¸€ä¸ªå¤§è‹±é›„çš„æ¢¦ã€‚æ¯å½“æµæ˜Ÿåˆ’è¿‡ï¼Œä»–éƒ½ä¼šè®¸æ„¿ï¼šæˆ‘è¦å‡­çœŸæœ¬äº‹ï¼Œå®ˆæŠ¤æˆ‘æƒ³å®ˆæŠ¤çš„äººï¼", 
        guide: "å®è´ï¼Œæˆ‘ä»¬æ¥ç”»è¿™é¢—å¸¦ç€å°¾å·´çš„æµæ˜Ÿã€‚ä¼¸å‡ºå°æ‰‹ï¼Œè·Ÿç€çº¢ç‚¹ï¼Œç”»å‡ºå®ƒé£å‘å¤©ç©ºçš„è½¨è¿¹ã€‚", 
        win: "å“‡ï¼è¿™é¢—æ˜Ÿå¤ªäº®äº†ï¼æˆ‘è¦æŠŠå®ƒç”»åœ¨æ´å£ï¼Œè®©å¦ˆå¦ˆæ™šä¸Šå›å®¶èƒ½çœ‹æ¸…è·¯ï¼" 
    },
    { 
        id: 2, type: 'svg', title: "å®çŸ³çˆ±å¿ƒ", icon: "â¤ï¸", path: PATHS.l2, speed: '8s', color: '#FF69B4',
        story: "å¦ˆå¦ˆæŠŠçˆ±è—åœ¨äº†ä¸€æ—¥ä¸‰é¤é‡Œï¼Œè—åœ¨äº†é‚£å£¶è£…æ»¡çš„æ°´é‡Œã€‚å°å¦–æ€ªæƒ³ï¼Œæ— è®ºå¤–é¢å¤šè¾›è‹¦ï¼Œå¦ˆå¦ˆçš„æ€€æŠ±æ°¸è¿œæ˜¯æœ€æ¸©æš–çš„æ¸¯æ¹¾ã€‚", 
        guide: "è¿™æ˜¯ä¸€ä¸ªåœ†æ¶¦çš„çˆ±å¿ƒï¼Œä»£è¡¨ç€æ»¡æ»¡çš„çˆ±ã€‚å·¦è¾¹ä¸€ä¸ªå¼¯ï¼Œå³è¾¹ä¸€ä¸ªå¼¯ï¼Œè¦ç”»å¾—é¥±æ»¡ä¸€ç‚¹å“¦ã€‚", 
        win: "å˜¿å˜¿ï¼Œæš–æš–çš„ï¼è¿™æ˜¯é€ç»™å¦ˆå¦ˆçš„ç¤¼ç‰©ï¼Œå¥¹è‚¯å®šä¼šæ‘¸æ‘¸æˆ‘çš„å¤´è¯´ï¼Œæˆ‘å®¶å°çŒªçœŸæ£’ï¼" 
    },
    { 
        id: 3, type: 'svg', title: "åƒå¹´å¤æ ‘", icon: "ğŸŒ³", path: PATHS.l3, speed: '10s', color: '#4CAF50',
        story: "æµªæµªå±±æœ‰ä¸€æ£µè€æ ‘ï¼Œç»å†è¿‡æ— æ•°é£å¹é›¨æ‰“ï¼Œä¾ç„¶æŠŠæ ¹æ·±æ·±åœ°æ‰åœ¨åœŸé‡Œã€‚å®ƒå‘Šè¯‰æˆ‘ä»¬ï¼šæ— è®ºé‡åˆ°ä»€ä¹ˆå›°éš¾ï¼Œéƒ½è¦ç«™ç›´äº†ï¼Œåˆ«è¶´ä¸‹ã€‚", 
        guide: "å¤§æ ‘æœ‰ç²—å£®çš„æ ‘å¹²ã€‚è·Ÿç€çº¢ç‚¹ï¼Œå…ˆç”»å‡ºå®ƒæŠ“åœ°çš„æ ‘æ ¹ï¼Œå†ç”»å‡ºè“¬æ¾çš„æ ‘å† ï¼Œè¦ç”»å¾—ç¨³ç¨³å½“å½“çš„ã€‚", 
        win: "å¥½å¤§ä¸€æ£µæ ‘ï¼ä¸‹æ¬¡å·¥ä½œç´¯äº†ï¼Œæˆ‘å°±åœ¨æ ‘ä¸‹ç¡ä¸ªæ‡’è§‰ï¼Œè°ä¹Ÿæ‰¾ä¸ç€æˆ‘ï¼è°¢è°¢ä½ å¸®æˆ‘ç§æ ‘ï¼" 
    },
    { 
        id: 4, type: 'img', title: "å¤§é¦™è•‰", icon: "ğŸŒ", img: "assets/4.jpg", 
        story: "å¥½ä¸œè¥¿è¦å’Œå¥½æœ‹å‹åˆ†äº«ã€‚è¿™ä¸²é¦™è•‰ç©¿ç€é‡‘é»„çš„å¤–å¥—ï¼Œå¼¯å¼¯çš„åƒå°èˆ¹ä¸€æ ·ã€‚çœŸæ­£çš„å¿«ä¹ï¼Œä¸æ˜¯ç‹¬è‡ªæ‹¥æœ‰ï¼Œè€Œæ˜¯åˆ†äº«åçš„åŒå€ç”œèœœã€‚", 
        guide: "çœ‹è¿™æ ¹å¤§é¦™è•‰ï¼Œé»„æ¾„æ¾„çš„ï¼Œå¼¯å¼¯çš„ã€‚æ²¿ç€è½®å»“ï¼ŒæŠŠè¿™ç¾å‘³çš„æ ·å­æå‡ºæ¥å§ã€‚", 
        win: "å¸æºœ...çœŸé¦™å•Šï¼æˆ‘çš„è‚šå­éƒ½å«äº†ã€‚ä¸è¿‡è¿™æ˜¯å‡†å¤‡å¥½çš„ç¤¼ç‰©ï¼Œæˆ‘ç»å¯¹ä¸å·åƒï¼Œæˆ‘å¯æ˜¯æœ€æœ‰åŸåˆ™çš„å°å¦–æ€ªï¼" 
    },
    { 
        id: 5, type: 'img', title: "æœºçµå°è›‡", icon: "ğŸ", img: "assets/5.jpg", 
        story: "è‰ä¸›é‡Œé’»å‡ºä¸€æ¡å°è›‡ï¼Œå®ƒæ˜¯å±±é‡Œçš„åŸä½æ°‘ã€‚ä¸‡ç‰©éƒ½æœ‰çµæ€§ï¼Œåªè¦ä½ ä¸å»ä¼¤å®³å®ƒï¼Œå®ƒä¹Ÿä¼šåœ¨å±±é‡Œé™é™åœ°é™ªç€ä½ ï¼Œåšå¤§è‡ªç„¶çš„å®ˆæŠ¤è€…ã€‚", 
        guide: "è¿™æ˜¯ä¸€æ¡ç›˜èµ·æ¥çš„å°è›‡ï¼Œèº«ä½“åƒèšŠé¦™ä¸€æ ·ç»•åœˆåœˆã€‚è¯·ä½ æ‹¿èµ·ç”»ç¬”ï¼Œè€å¿ƒåœ°æŠŠè¿™äº›èºæ—‹çº¿ææ¸…æ¥šï¼Œæ‰‹ä¸è¦æŠ–å“¦ã€‚", 
        win: "å“‡å‘€ï¼ç”»å¾—å¥½åƒï¼å®ƒåˆšæ‰å¥½åƒåäº†ä¸€ä¸‹ä¿¡å­ï¼Ÿå“ˆå“ˆï¼Œåˆ«æ€•ï¼Œè¿™æ˜¯æˆ‘çš„å¥½é‚»å±…ï¼Œå®ƒå¸®æˆ‘ä»¬çœ‹å®ˆåå±±å‘¢ï¼" 
    },
    { 
        id: 6, type: 'img', title: "ç™½é¾™é©¬", icon: "ğŸ´", img: "assets/6.jpg", 
        story: "è¿œè¿œåœ°ï¼Œçœ‹åˆ°ä¸€åŒ¹ç™½é©¬ï¼Œæ˜‚é¦–æŒºèƒ¸ã€‚å®ƒä¸è¿œä¸‡é‡Œå»å–ç»ï¼Œé çš„ä¸æ˜¯é£ç¿”ï¼Œè€Œæ˜¯ä¸€æ­¥ä¸€ä¸ªè„šå°çš„åšæŒã€‚è¡Œè·¯éš¾ï¼Œä½†åªè¦èµ°ï¼Œå°±ä¸€å®šèƒ½åˆ°ã€‚", 
        guide: "ç™½é¾™é©¬çœŸç¥æ°”ï¼æ³¨æ„çœ‹å®ƒçš„é¬ƒæ¯›ï¼Œæ˜¯è¢«é£å¹èµ·æ¥çš„ã€‚è¯·ä»”ç»†åœ°æå‡ºå®ƒå¸…æ°”çš„ä¾§è„¸ï¼Œç”»å‡ºå®ƒçš„ç²¾æ°”ç¥ã€‚", 
        win: "å¤ªå¸…äº†ï¼æˆ‘ä¹Ÿæƒ³ç»ƒå¥½æœ¬äº‹ï¼Œä»¥åéª‘ç€å®ƒå»çœ‹çœ‹å±±å¤–é¢çš„ä¸–ç•Œï¼ç”»å¾—çœŸå¥½ï¼Œæ„Ÿè§‰å®ƒä¸‹ä¸€ç§’å°±è¦è·‘èµ·æ¥äº†ï¼" 
    },
    { 
        id: 7, type: 'img', title: "å‰‘é¾™å®å®", icon: "ğŸ¦•", img: "assets/7.jpg", 
        story: "å°å¦–æ€ªåœ¨åå±±æŒ–åˆ°äº†ä¸€ä¸ªå·¨å¤§çš„éª¨å¤´ã€‚åŸæ¥å¾ˆä¹…ä»¥å‰ï¼Œè¿™é‡Œç”Ÿæ´»ç€ç¥å¥‡çš„æé¾™ã€‚ä¿æŒä¸€é¢—å¥½å¥‡å¿ƒï¼Œä½ å°±ä¼šå‘ç°ï¼Œä¸–ç•Œå¤„å¤„éƒ½æ˜¯æƒŠå–œã€‚", 
        guide: "è¿™åªæé¾™èƒŒä¸Šé•¿æ»¡äº†å°–å°–çš„éª¨æ¿ï¼Œåƒä¸€æ’å°å±±å³°ã€‚è¯·ä½ æ²¿ç€è½®å»“ï¼ŒæŠŠè¿™äº›é”¯é½¿ä¸€æ ·çš„å½¢çŠ¶æå‡ºæ¥ã€‚", 
        win: "å¼â€”â€”ï¼è¿™ä¹ˆå¤§çš„å—å¤´ï¼è¦æ˜¯èƒ½å…»ä¸€åªï¼Œæˆ‘å°±å†ä¹Ÿä¸æ€•è¢«ç‹¼å¤§äººæ¬ºè´Ÿå•¦ï¼ä½ çœŸå‰å®³ï¼Œè¿è¿™ä¹ˆå¤è€çš„æ€ªå…½éƒ½ä¼šç”»ï¼" 
    },
    { 
        id: 8, type: 'img', title: "å‘æ—¥è‘µ", icon: "ğŸŒ»", img: "assets/8.jpg", 
        story: "ç”Ÿæ´»è™½ç„¶è¾›è‹¦ï¼Œä½†æˆ‘ä»¬è¦åƒå‘æ—¥è‘µä¸€æ ·ï¼Œæ°¸è¿œæŠŠè„¸è½¬ç€æœ‰å…‰çš„åœ°æ–¹ã€‚å¿ƒé‡Œæœ‰å…‰ï¼Œæ—¥å­å°±ä¸æš—ï¼›å˜´è§’æœ‰ç¬‘ï¼Œè¿æ°”å°±ä¸ä¼šå·®ã€‚", 
        guide: "å‘æ—¥è‘µçš„èŠ±ç›˜åœ†åœ†çš„ï¼Œå‘¨å›´æ˜¯ä¸€åœˆæ¼‚äº®çš„èŠ±ç“£ï¼Œåƒä¸ªå°å¤ªé˜³ã€‚è¯·ä»”ç»†è§‚å¯Ÿï¼ŒæŠŠæ¯ä¸€ç‰‡èŠ±ç“£éƒ½ææ¸…æ¥šï¼Œä¸è¦æ¼æ‰å“¦ã€‚", 
        win: "å˜¿å˜¿ï¼ŒçœŸå¥½çœ‹ï¼çœ‹åˆ°è¿™æœµèŠ±ï¼Œæˆ‘å°±è§‰å¾—è‡ªå·±å……æ»¡äº†åŠ›æ°”ï¼æ˜å¤©æˆ‘è¦æ—©èµ·å»å·¡å±±ï¼Œåšä¸€ä¸ªå¿«ä¹çš„å°å¦–æ€ªï¼" 
    },
    { 
        id: 9, type: 'img', title: "è›¤èŸ†å¤§å“¥", icon: "ğŸ¸", img: "assets/9.jpg", 
        story: "è¿™æ˜¯å°çŒªå¦–çš„å¥½ä¼™ä¼´ã€‚åœ¨æµªæµªå±±ï¼Œè™½ç„¶å¤§å®¶éƒ½æ˜¯å°äººç‰©ï¼Œä½†æœ‹å‹ä¹‹é—´äº’ç›¸å¸®è¡¬ã€äº’ç›¸æ‰“æ°”ï¼Œè¿™ä»½æƒ…è°Šæ¯”é‡‘å­è¿˜çè´µã€‚", 
        guide: "è›¤èŸ†å¤§å“¥æœ‰ä¸¤åªé¼“é¼“çš„å¤§çœ¼ç›å’Œä¸€å¼ å®½å®½çš„å˜´å·´ï¼Œçœ‹èµ·æ¥å¾ˆæœ‰ç²¾ç¥ã€‚è¯·æ²¿ç€ç°è‰²çš„çº¿æ¡ï¼ŒæŠŠè¿™ä¸ªç‹¬ç‰¹çš„ä¼™ä¼´ç”»å‡ºæ¥ã€‚", 
        win: "å‘±å‘±ï¼è¿™æ˜¯æˆ‘æœ€å¥½çš„å“¥ä»¬ï¼æ¯æ¬¡æˆ‘ä¸æƒ³å¹²æ´»çš„æ—¶å€™ï¼Œéƒ½æ˜¯ä»–é™ªæˆ‘èŠå¤©ã€‚è°¢è°¢ä½ æŠŠä»–ç”»å¾—è¿™ä¹ˆç²¾ç¥ï¼Œæˆ‘è¦æ‹¿å»ç»™ä»–çœ‹ï¼" 
    },
    { 
        id: 10, type: 'img', title: "é»„é¼ ç‹¼", icon: "ğŸ“œ", img: "assets/10.jpg", 
        story: "é»„é¼ ç‹¼è™½ç„¶çœ‹èµ·æ¥ç˜¦å°ï¼Œä½†ä»–å°±åƒè¥¿æ¸¸è®°é‡Œçš„æ²™åƒ§ä¸€æ ·ï¼Œæœ€è‚¯å¹²è„æ´»ç´¯æ´»ã€‚ä»–ä¸æ€•è‹¦ï¼Œæ€»æŠŠæœ€é‡çš„æ‹…å­æ‰›åœ¨è‚©ä¸Šï¼Œæ˜¯ä¸€ä¸ªå€¼å¾—ä¿¡èµ–çš„è€å®äººã€‚", 
        guide: "é»„é¼ ç‹¼çœ¼ç¥åšå®šï¼Œæ‰‹é‡Œä¼¼ä¹è¿˜æŒ‘ç€æ‹…å­ã€‚æˆ‘ä»¬æ¥æç”»ä»–æœ´å®çš„æ ·å­ï¼Œçº¿æ¡è¦ç¨³ä¸€ç‚¹ï¼Œç”»å‡ºä»–çš„æ†¨åšåŠ²å„¿ã€‚", 
        win: "å˜¿å˜¿ï¼Œæˆ‘è™½ç„¶ä¸èªæ˜ï¼Œä½†æˆ‘æœ‰åŠ›æ°”ï¼æœ€é‡çš„è¡Œæéƒ½äº¤ç»™æˆ‘å§ï¼Œæˆ‘ä¸€å®šèƒ½æŒ‘åˆ°è¥¿å¤©å»ï¼è°¢è°¢ä½ æŠŠæˆ‘ç”»å¾—è¿™ä¹ˆç»“å®ï¼" 
    },
    { 
        id: 11, type: 'img', title: "å°çŒªå¦–", icon: "ğŸ·", img: "assets/11.jpg", 
        story: "ç»ˆäºç”»åˆ°ä¸»è§’äº†ã€‚å­©å­ï¼Œä½ å°±æ˜¯è‡ªå·±æ•…äº‹é‡Œçš„ä¸»è§’ã€‚æ— è®ºåˆ«äººæ€ä¹ˆçœ‹ï¼Œä½ éƒ½è¦çˆ±è‡ªå·±ï¼Œç›¸ä¿¡è‡ªå·±æ˜¯ç‹¬ä¸€æ— äºŒçš„å®è´ã€‚", 
        guide: "è¿™æ˜¯æˆ‘ä»¬çš„å°çŒªå¦–ï¼ä»–æœ‰å¤§å¤§çš„æ‹›é£è€³å’Œçº¢çº¢çš„é¬ƒæ¯›ã€‚è¯·å¸¦ç€çˆ±æ„ï¼ŒæŠŠè¿™ä¸ªå‹‡æ•¢ã€å–„è‰¯çš„å°å®¶ä¼™æç”»å‡ºæ¥ã€‚", 
        win: "å¤©å“ªï¼è¿™æ˜¯æˆ‘å—ï¼Ÿæˆ‘æœ‰è¿™ä¹ˆå¸…å—ï¼Ÿè¿™è€³æœµç”»å¾—çœŸå¥½ï¼Œè¿™é¼»å­çœŸæŒºæ‹”ï¼æˆ‘è¦æŠŠè¿™å¹…ç”»æŒ‚åœ¨æœ€æ˜¾çœ¼çš„åœ°æ–¹ï¼æˆ‘ä¸ºä½ éª„å‚²ï¼" 
    },
    { 
        id: 12, type: 'img', title: "çŒ©çŒ©æ€ª", icon: "ğŸ¦", img: "assets/12.jpg", 
        story: "çœ‹è¿™å¤§å—å¤´ï¼Œå¤´ä¸Šæ’ç€ç¿æ¯›ï¼Œè„¸ä¸Šç”»ç€è„¸è°±ï¼Œæ­£å–åŠ›åœ°æ‰®æ¼”é½å¤©å¤§åœ£å‘¢ã€‚è™½ç„¶æ ·å­æœ‰ç‚¹æ»‘ç¨½ï¼Œä½†åªè¦æ•¢äºå°è¯•ï¼Œä½ å°±æ˜¯è‡ªå·±çš„è‹±é›„ã€‚", 
        guide: "è¿™åªçŒ©çŒ©æ€ªæ‰“æ‰®å¾—çœŸç¥æ°”ï¼è¯·æŠ“ä½ä»–è¿™å‰¯â€œè£…æ¨¡ä½œæ ·â€åˆæ†¨æ€å¯æ¬çš„ç¥æƒ…ï¼ŒæŠŠå®ƒç”ŸåŠ¨åœ°æå‡ºæ¥ã€‚", 
        win: "å“ˆå“ˆå“ˆå“ˆï¼åŸæ¥æ˜¯çŒ©çŒ©å¤§å“¥ï¼ä½ ç©¿æˆè¿™æ ·ï¼Œæˆ‘éƒ½å·®ç‚¹è®¤ä¸å‡ºæ¥äº†ï¼è™½ç„¶æ²¡æœ‰å¤§åœ£é‚£ä¹ˆå¸…ï¼Œä½†è¿™èº«è¡Œå¤´ä¹ŸæŒºå¨é£çš„ï¼æ¼”å¾—ä¸é”™ï¼Œæ»¡åˆ†ï¼" 
    }
];

createApp({
    setup() {
        const state = ref('welcome');
        const roles = ref(ROLES);
        const selectedRole = ref(null);
        const levels = ref(LEVELS);
        const maxLevel = ref(0);
        const activeIdx = ref(0);
        const currentLevel = computed(() => levels.value[activeIdx.value]);
        const showModal = ref(false);
        const isLevelDone = ref(false);
        const imgError = ref({});
        const errorMsg = ref('');

        const canvasRef = ref(null);
        const stageRef = ref(null);
        const isEraser = ref(false);
        let ctx = null;
        let isDrawing = false;
        let points = [];
        let strokeCount = 0;

        let synth = window.speechSynthesis;
        let voices = [];

        // --- æ ¸å¿ƒä¿®å¤ï¼šå®‰å…¨å¯åŠ¨æµç¨‹ ---
        const startApp = () => {
            // 1. ä¼˜å…ˆåˆ‡æ¢é¡µé¢çŠ¶æ€ (ç¡®ä¿ç‚¹å‡»å¿…å®šæœ‰ååº”)
            state.value = 'select';
            
            // 2. å°è¯•æ’­æ”¾å£°éŸ³ (å®¹é”™å¤„ç†)
            try {
                initAudio();
                const welcomeText = "æ¬¢è¿æ¥åˆ°æµªæµªå±±ï¼Œè¿™é‡Œçš„æ¯ä¸€ç¬”éƒ½æ˜¯é­”æ³•ï¼";
                speak(welcomeText, 'story');
            } catch (e) {
                console.warn("è¯­éŸ³åˆå§‹åŒ–å¤±è´¥ï¼Œä½†ä¸å½±å“æ¸¸æˆè¿è¡Œ", e);
            }

            // 3. æ£€æŸ¥å°é¢ (é™é»˜æ£€æŸ¥)
            const img = new Image();
            img.onerror = () => imgError.value.cover = true;
            img.src = 'assets/cover.jpg';
        };

        const onImgError = (name) => {
            errorMsg.value = `âš ï¸ ç¼ºå°‘å›¾ç‰‡: ${name}.jpg`;
            setTimeout(() => errorMsg.value = '', 3000);
        };

        const initAudio = () => {
            if(synth.onvoiceschanged !== undefined) synth.onvoiceschanged = () => voices = synth.getVoices();
            voices = synth.getVoices();
            synth.speak(new SpeechSynthesisUtterance('')); // æ¿€æ´»
        };

        const speak = (text, type, onEnd) => {
            try {
                synth.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'zh-CN';
                
                if (type === 'story') { u.rate = 0.8; u.pitch = 0.6; 
                    const male = voices.find(v => v.lang.includes('zh') && (v.name.includes('Male') || v.name.includes('Yun')));
                    if(male) u.voice = male;
                } 
                else if (type === 'guide') { u.rate = 1.0; u.pitch = 1.2; } 
                else if (type === 'role') { u.rate = 1.3; u.pitch = 1.6; }
                
                if (onEnd) {
                    u.onend = onEnd;
                    // å…œåº•ï¼šé˜²æ­¢å®‰å“TTSå›è°ƒå¤±æ•ˆ
                    setTimeout(() => { if (isLevelDone.value) onEnd(); }, text.length * 300 + 2000);
                }
                
                synth.speak(u);
            } catch(e) {
                console.error("TTS Error", e);
                // å¦‚æœè¯­éŸ³å½»åº•å¤±è´¥ï¼Œç›´æ¥æ‰§è¡Œå›è°ƒ
                if (onEnd) onEnd();
            }
        };

        const tryRole = (role) => {
            selectedRole.value = role;
            let intro = "å˜¿å˜¿ï¼æˆ‘æ˜¯å°çŒªå¦–ï¼Œé€‰æˆ‘é€‰æˆ‘ï¼";
            if (role.id === 'frog') intro = "å‘±å‘±ï¼æˆ‘æ˜¯æœ€è®²ä¹‰æ°”çš„è›¤èŸ†å¤§å“¥ï¼";
            if (role.id === 'weasel') intro = "æˆ‘æ˜¯è€å®çš„é»„é¼ ç‹¼ï¼Œè®©æˆ‘æ¥æŒ‘æ‹…å­å§ï¼";
            if (role.id === 'gorilla') intro = "æˆ‘æ˜¯çŒ©çŒ©æ€ªï¼Œçœ‹æˆ‘å˜èº«é½å¤©å¤§åœ£ï¼";
            speak(intro, 'role');
        };

        const confirmRole = () => {
            state.value = 'map';
            speak("å‡ºå‘å’¯ï¼è®©æˆ‘ä»¬å»ç”»ç”»ï¼", 'role');
        };

        const enterLevel = (idx) => {
            if(idx > maxLevel.value) return;
            activeIdx.value = idx;
            showModal.value = true;
            speak(currentLevel.value.story, 'story');
        };

        const startGame = () => {
            showModal.value = false;
            state.value = 'game';
            isLevelDone.value = false;
            strokeCount = 0;
            isEraser.value = false;
            speak(currentLevel.value.guide, 'guide');
            setTimeout(initCanvas, 300);
        };

        const backToMap = () => {
            state.value = 'map';
            synth.cancel();
        };

        // --- ç”»å¸ƒé€»è¾‘ ---
        const setTool = (val) => {
            isEraser.value = val;
            if(!ctx) return;
            ctx.lineWidth = val ? 25 : 10; 
            ctx.globalCompositeOperation = val ? 'destination-out' : 'source-over';
        };

        const initCanvas = () => {
            const canvas = canvasRef.value;
            const container = stageRef.value;
            if(!canvas || !container) return;

            const rect = container.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 2; 
            
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            
            ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);
            
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#5D4037';
            setTool(false);

            const getPos = (e) => {
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };

            const start = (e) => {
                isDrawing = true;
                const p = getPos(e);
                ctx.beginPath();
                ctx.moveTo(p.x, p.y);
            };

            const move = (e) => {
                if(!isDrawing) return;
                e.preventDefault();
                const p = getPos(e);
                ctx.lineTo(p.x, p.y);
                ctx.stroke();
                if(!isEraser.value) strokeCount++;
            };

            const end = () => { isDrawing = false; };

            canvas.onpointerdown = (e) => {
                canvas.setPointerCapture(e.pointerId);
                start(e);
            };
            canvas.onpointermove = move;
            canvas.onpointerup = (e) => {
                canvas.releasePointerCapture(e.pointerId);
                end();
            };
        };

        const checkResult = () => {
            if(strokeCount < 10) {
                speak("å®è´ï¼Œå†å¤šç”»å‡ ç¬”å§ï¼", 'guide');
                return;
            }
            isLevelDone.value = true;
            
            if (currentLevel.value.type !== 'svg') {
                ctx.clearRect(0,0, canvasRef.value.width, canvasRef.value.height);
            }
            
            confetti({ particleCount: 200, spread: 150, origin: { y: 0.6 } });
            
            speak(currentLevel.value.win, 'role', () => {
                setTimeout(() => {
                    if(activeIdx.value < LEVELS.length - 1) {
                        maxLevel.value = Math.max(maxLevel.value, activeIdx.value + 1);
                        activeIdx.value++;
                        isLevelDone.value = false;
                        showModal.value = true;
                        speak(currentLevel.value.story, 'story'); 
                    } else {
                        if(confirm("å…¨éƒ¨é€šå…³ï¼å¤ªæ£’äº†ï¼")) backToMap();
                    }
                }, 500); 
            });
        };

        return {
            state, roles, levels, selectedRole, maxLevel, currentLevel, imgError, errorMsg,
            showModal, isLevelDone, canvasRef, stageRef, isEraser,
            startApp, onImgError, tryRole, confirmRole, enterLevel, startGame, backToMap, checkResult, setTool
        };
    }
}).mount('#app');
</script>
</body>
</html>